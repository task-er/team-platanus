<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë¨¸ì§€ ë§¤ì¥ íƒ€ìš´</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: stretch;
        background: #05070f;
        color: #f9fafb;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      .wrap {
        width: 100%;
        max-width: 520px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      header {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      header h1 {
        font-size: 20px;
        font-weight: 600;
      }
      .money {
        font-size: 14px;
        color: #e5e7eb;
      }
      .money strong {
        font-size: 18px;
        color: #facc15;
      }
      .panel {
        background: #0b1120;
        border-radius: 12px;
        padding: 12px;
        border: 1px solid #111827;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
        margin-bottom: 10px;
        font-size: 13px;
        color: #9ca3af;
      }
      .controls-text {
        display: flex;
        flex-direction: column;
        gap: 3px;
        max-width: 60%;
      }
      .controls-sub {
        font-size: 11px;
        color: #6b7280;
      }
      .controls button {
        border: 0;
        border-radius: 999px;
        padding: 8px 14px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        background: #1d4ed8;
        color: #f9fafb;
        transition: transform 0.08s ease-out, box-shadow 0.08s ease-out,
          opacity 0.08s ease-out;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
        white-space: nowrap;
      }
      .controls button.secondary {
        background: #111827;
        box-shadow: none;
        color: #e5e7eb;
        border: 1px solid #374151;
      }
      .controls button:disabled {
        opacity: 0.45;
        cursor: default;
        box-shadow: none;
        transform: none;
      }
      .controls button:active:not(:disabled) {
        transform: translateY(1px);
        box-shadow: 0 2px 6px rgba(37, 99, 235, 0.4);
      }

      .board {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }
      .tile {
        position: relative;
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        background: radial-gradient(circle at 20% 0%, #111827, #020617);
        border: 1px solid #111827;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        cursor: pointer;
        transition: border-color 0.1s ease-out, box-shadow 0.1s ease-out,
          transform 0.06s ease-out;
        font-size: 13px;
        color: #9ca3af;
      }
      .tile.has-shop {
        background: radial-gradient(circle at 0% 0%, #1f2937, #020617);
        border-color: #1f2937;
        color: #e5e7eb;
      }
      .tile:hover {
        border-color: #2563eb;
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
      }
      .tile.selected {
        border-color: #f97316;
        box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.8);
        transform: translateY(-1px);
      }
      .tile .empty {
        font-size: 18px;
        opacity: 0.4;
      }
      .shop {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: stretch;
        gap: 4px;
      }
      .shop-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
      }
      .shop-level {
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.4);
        font-weight: 600;
      }
      .shop-icon {
        font-size: 18px;
      }
      .shop-gauge {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 11px;
        color: #9ca3af;
      }
      .gauge-bar {
        position: relative;
        width: 100%;
        height: 8px;
        border-radius: 999px;
        background: #020617;
        overflow: hidden;
        border: 1px solid #111827;
      }
      .gauge-fill {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0%;
        border-radius: inherit;
        background: linear-gradient(90deg, #22c55e, #a3e635);
        transition: width 0.15s ease-out;
      }
      .shop-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
      }
      .play-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid #1d4ed8;
        color: #dbeafe;
        text-decoration: none;
        font-size: 11px;
        gap: 4px;
        background: rgba(15, 23, 42, 0.9);
      }
      .play-link span {
        font-size: 12px;
      }
      .hint {
        font-size: 11px;
        color: #6b7280;
        margin-top: 8px;
        line-height: 1.4;
      }
      .hint strong {
        color: #e5e7eb;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>ë¨¸ì§€ ë§¤ì¥ íƒ€ìš´</h1>
        <div class="money">
          ë³´ìœ  ê³¨ë“œ:
          <strong id="moneyText">0</strong>
          <span>G</span>
        </div>
      </header>

      <section class="panel">
        <div class="controls">
          <div class="controls-text">
            <div>ê°™ì€ ë ˆë²¨ ë§¤ì¥ 2ê°œë¥¼ ì„ íƒí•´ì„œ <strong>í•©ì¹˜ê¸°</strong></div>
            <div class="controls-sub">
              ê²Œì´ì§€ê°€ <strong>100%</strong>ì¸ ë§¤ì¥ì€
              <strong>ì „ì²´ ìˆ˜ë ¹</strong>ìœ¼ë¡œ ê³¨ë“œë¡œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.
            </div>
          </div>
          <div>
            <button id="collectBtn" class="secondary" disabled>
              ì „ì²´ ìˆ˜ë ¹
            </button>
            <button id="spawnBtn">ìƒˆ ë§¤ì¥ ìƒì„± (1,000G)</button>
            <button id="resetBtn" class="secondary">ì´ˆê¸°í™”</button>
          </div>
        </div>
        <div id="board" class="board" aria-label="ë§¤ì¥ ë°°ì¹˜ ë³´ë“œ"></div>
        <p class="hint">
          Â· ë§¤ì¥ì„ í•œ ë²ˆ í´ë¦­í•´ì„œ ì„ íƒí•œ ë’¤, <strong>ë‹¤ë¥¸ ì¹¸ì„ í´ë¦­</strong>í•˜ë©´
          ì´ë™í•˜ê±°ë‚˜ í•©ì³ì§‘ë‹ˆë‹¤.<br />
          Â· ë§¤ì¥ ì•ˆì˜ <strong>ì˜ì—…í•˜ê¸°</strong>ë¥¼ ëˆ„ë¥´ë©´
          <code>/ingame.html?shopId=...</code>ë¡œ ì´ë™í•´ì„œ ê²Œì´ì§€ë¥¼ ì±„ìš¸ ìˆ˜
          ìˆì–´ìš”.<br />
          Â· ê²Œì´ì§€ê°€ 100%ê°€ ëœ ë§¤ì¥ì€ <strong>ì „ì²´ ìˆ˜ë ¹</strong>ìœ¼ë¡œ ê³¨ë“œë¥¼
          íšë“í•©ë‹ˆë‹¤.
        </p>
      </section>
    </div>

    <script>
      const STORAGE_KEY = "merge-town-v1";

      function createInitialState() {
        const tilesCount = 16; // 4x4 ë³´ë“œ
        const tiles = new Array(tilesCount).fill(null);

        const shopId = 1;
        // ê°€ìš´ë° ìœ„ì¹˜ì— ì²« ë§¤ì¥
        const centerIndex = 5; // ëŒ€ì¶© ì¤‘ê°„ (4x4 ê¸°ì¤€ 5ë²ˆ ì¹¸)
        tiles[centerIndex] = shopId;

        return {
          money: 100000,
          nextShopId: 2,
          tiles,
          shops: {
            [shopId]: { id: shopId, level: 1, gauge: 0 },
          },
        };
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return createInitialState();
          const parsed = JSON.parse(raw);
          // ìµœì†Œ í•„ë“œ ì²´í¬
          if (
            typeof parsed !== "object" ||
            parsed === null ||
            !Array.isArray(parsed.tiles) ||
            typeof parsed.money !== "number" ||
            typeof parsed.nextShopId !== "number" ||
            typeof parsed.shops !== "object"
          ) {
            return createInitialState();
          }
          return parsed;
        } catch (e) {
          console.error("ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨, ì´ˆê¸°í™”í•©ë‹ˆë‹¤.", e);
          return createInitialState();
        }
      }

      function saveState() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.error("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨", e);
        }
      }

      let state = loadState();
      const boardEl = document.getElementById("board");
      const moneyText = document.getElementById("moneyText");
      const spawnBtn = document.getElementById("spawnBtn");
      const resetBtn = document.getElementById("resetBtn");
      const collectBtn = document.getElementById("collectBtn");

      let selectedIndex = null;

      // ê²Œì´ì§€ ê½‰ ì°¬ ë§¤ì¥ ì§‘ê³„
      function getCollectSummary() {
        const result = {
          count: 0,
          totalGold: 0,
          ids: [],
        };

        for (const key in state.shops) {
          const shop = state.shops[key];
          if (!shop) continue;

          // ì‹¤ì œ ë³´ë“œì— ì˜¬ë¼ì™€ ìˆëŠ” ë§¤ì¥ë§Œ ë³´ìƒ
          const onBoard = state.tiles.includes(shop.id);
          if (!onBoard) continue;

          const gauge = typeof shop.gauge === "number" ? shop.gauge : 0;
          if (gauge >= 100) {
            const level = Math.max(1, shop.level || 1);

            // ====== ë³´ìƒ ë°¸ëŸ°ìŠ¤ ======
            // í•œ ë§¤ì¥ì´ ê²Œì´ì§€ 100%ê°€ ë˜ë©´:
            //   reward = 500 * (ë ˆë²¨^2)
            // ì˜ˆ) Lv1: 500G, Lv2: 2,000G, Lv3: 4,500G, Lv4: 8,000G ...
            // (í•„ìš”í•˜ë©´ ì—¬ê¸° ê³„ìˆ˜ë§Œ ì¡°ì ˆí•˜ë©´ ë¨)
            const reward = Math.round(500 * level * level);

            result.count++;
            result.totalGold += reward;
            result.ids.push(shop.id);
          }
        }

        return result;
      }

      function updateCollectButton() {
        if (!collectBtn) return;
        const summary = getCollectSummary();
        if (summary.count > 0 && summary.totalGold > 0) {
          collectBtn.disabled = false;
          collectBtn.textContent = `ì „ì²´ ìˆ˜ë ¹ (${
            summary.count
          }ê°œ, +${summary.totalGold.toLocaleString("ko-KR")}G)`;
        } else {
          collectBtn.disabled = true;
          collectBtn.textContent = "ì „ì²´ ìˆ˜ë ¹";
        }
      }

      function render() {
        moneyText.textContent = state.money.toLocaleString("ko-KR");

        boardEl.innerHTML = "";
        state.tiles.forEach((shopId, index) => {
          const tile = document.createElement("button");
          tile.type = "button";
          tile.className = "tile";
          tile.dataset.index = String(index);

          if (shopId === null || shopId === undefined) {
            const span = document.createElement("span");
            span.className = "empty";
            span.textContent = "+";
            tile.appendChild(span);
          } else {
            const shop = state.shops[shopId];
            if (!shop) {
              // ë°ì´í„°ê°€ ê¼¬ì˜€ìœ¼ë©´ ë¹„ìš°ê¸°
              tile.innerHTML = '<span class="empty">+</span>';
              state.tiles[index] = null;
            } else {
              tile.classList.add("has-shop");

              const container = document.createElement("div");
              container.className = "shop";

              const top = document.createElement("div");
              top.className = "shop-top";

              const level = document.createElement("div");
              level.className = "shop-level";
              level.textContent = `Lv.${shop.level}`;

              const icon = document.createElement("div");
              icon.className = "shop-icon";
              // ë ˆë²¨ì— ë”°ë¼ ê°„ë‹¨íˆ ì´ëª¨ì§€ ë³€ê²½
              const icons = ["ğŸšï¸", "ğŸ ", "ğŸª", "ğŸ¢", "ğŸ¬", "ğŸ¦", "ğŸ¨", "ğŸ©"];
              icon.textContent =
                icons[Math.min(shop.level - 1, icons.length - 1)];

              top.appendChild(level);
              top.appendChild(icon);

              const gauge = document.createElement("div");
              gauge.className = "shop-gauge";

              const bar = document.createElement("div");
              bar.className = "gauge-bar";

              const fill = document.createElement("div");
              fill.className = "gauge-fill";
              const gaugeValue = Math.max(0, Math.min(shop.gauge || 0, 100));
              fill.style.width = gaugeValue + "%";
              bar.appendChild(fill);

              const gaugeLabel = document.createElement("div");
              gaugeLabel.textContent = `ê²Œì´ì§€: ${Math.round(
                shop.gauge || 0
              )}%`;

              gauge.appendChild(bar);
              gauge.appendChild(gaugeLabel);

              const bottom = document.createElement("div");
              bottom.className = "shop-bottom";

              const info = document.createElement("div");
              info.textContent = "ì˜ì—… ê²Œì´ì§€";

              const playLink = document.createElement("a");
              playLink.href = `ingame.html?shopId=${shop.id}`;
              playLink.className = "play-link";
              playLink.innerHTML = `<span>â–¶</span> ì˜ì—…í•˜ê¸°`;

              bottom.appendChild(info);
              bottom.appendChild(playLink);

              container.appendChild(top);
              container.appendChild(gauge);
              container.appendChild(bottom);
              tile.appendChild(container);
            }
          }

          if (selectedIndex === index) {
            tile.classList.add("selected");
          }

          boardEl.appendChild(tile);
        });

        updateCollectButton();
      }

      function clearSelection() {
        selectedIndex = null;
        document
          .querySelectorAll(".tile.selected")
          .forEach((el) => el.classList.remove("selected"));
      }

      function handleTileClick(index, eventTarget) {
        // play-link í´ë¦­ì´ë©´ ë¨¸ì§€/ì´ë™ ë¬´ì‹œ
        if (eventTarget.closest && eventTarget.closest("a.play-link")) {
          return;
        }

        const shopId = state.tiles[index];

        if (selectedIndex === null) {
          // ì„ íƒ ì‹œì‘: ë§¤ì¥ì´ ìˆì„ ë•Œë§Œ
          if (shopId == null) return;
          selectedIndex = index;
          render();
          return;
        }

        if (selectedIndex === index) {
          // ê°™ì€ ì¹¸ ë‹¤ì‹œ í´ë¦­ -> ì„ íƒ ì·¨ì†Œ
          clearSelection();
          render();
          return;
        }

        const fromIndex = selectedIndex;
        const fromId = state.tiles[fromIndex];
        const toId = state.tiles[index];

        if (fromId == null) {
          clearSelection();
          render();
          return;
        }

        if (toId == null) {
          // ë‹¨ìˆœ ì´ë™
          state.tiles[index] = fromId;
          state.tiles[fromIndex] = null;
        } else {
          const fromShop = state.shops[fromId];
          const toShop = state.shops[toId];
          if (fromShop && toShop && fromShop.level === toShop.level) {
            // ë¨¸ì§€: ëŒ€ìƒ ì¹¸ìœ¼ë¡œ í•©ì¹˜ê³  ë ˆë²¨+1, gaugeëŠ” 0ìœ¼ë¡œ ë¦¬ì…‹
            toShop.level += 1;
            toShop.gauge = 0; // ìƒˆ ë§¤ì¥ì€ ê²Œì´ì§€ ë¹„ìš´ ìƒíƒœë¡œ ì‹œì‘

            // ì›ë˜ ë§¤ì¥ ì‚­ì œ
            delete state.shops[fromId];
            state.tiles[fromIndex] = null;
          } else {
            // ë ˆë²¨ ë‹¤ë¥´ë©´ ìœ„ì¹˜ êµí™˜
            state.tiles[fromIndex] = toId;
            state.tiles[index] = fromId;
          }
        }

        clearSelection();
        saveState();
        render();
      }

      boardEl.addEventListener("click", (e) => {
        const tile = e.target.closest(".tile");
        if (!tile) return;
        const idx = Number(tile.dataset.index);
        handleTileClick(idx, e.target);
      });

      spawnBtn.addEventListener("click", () => {
        const emptyIndex = state.tiles.findIndex((id) => id == null);
        if (emptyIndex === -1) {
          alert("ë¹ˆ ì¹¸ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        const cost = 1000;
        if (state.money < cost) {
          alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.");
          return;
        }

        state.money -= cost;
        const id = state.nextShopId++;
        state.shops[id] = { id, level: 1, gauge: 0 };
        state.tiles[emptyIndex] = id;

        saveState();
        render();
      });

      resetBtn.addEventListener("click", () => {
        if (!confirm("ì „ì²´ ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
        state = createInitialState();
        saveState();
        clearSelection();
        render();
      });

      collectBtn.addEventListener("click", () => {
        const summary = getCollectSummary();
        if (summary.count === 0 || summary.totalGold <= 0) {
          alert("ìˆ˜ë ¹í•  ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        state.money += summary.totalGold;
        summary.ids.forEach((id) => {
          const shop = state.shops[id];
          if (shop) shop.gauge = 0;
        });

        saveState();
        render();

        alert(
          `ì´ ${summary.totalGold.toLocaleString("ko-KR")}Gë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤!`
        );
      });

      render();
    </script>
  </body>
</html>
