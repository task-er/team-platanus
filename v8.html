<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ëŒ€ê°ì„  3Ã—3 ë¨¸ì§€ ìƒì </title>
    <style>
      :root {
        --bg: #0e1014;
        --panel: #151821;
        --card: #1b2130;
        --accent: #7dd3fc;
        --accent-2: #a78bfa;
        --good: #34d399;
        --warn: #fbbf24;
        --bad: #f87171;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --grid-gap: 16px;
        --cell-size: min(22vw, 120px);
        --radius: 12px;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #0d1117, #0e131b);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard,
          Apple SD Gothic Neo, Noto Sans KR, sans-serif;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }
      .wrap {
        width: min(1000px, 100%);
        padding: 16px;
        display: grid;
        gap: 16px;
        grid-template-rows: auto 1fr auto;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--panel);
        border: 1px solid #212636;
        border-radius: var(--radius);
        padding: 12px 16px;
        box-shadow: var(--shadow);
      }
      .gold {
        font-weight: 700;
        font-size: 1.05rem;
      }
      .gold .val {
        color: #ffd76a;
      }
      .meta {
        display: flex;
        gap: 14px;
        align-items: center;
        color: var(--muted);
        font-size: 0.95rem;
      }
      .tag {
        padding: 4px 8px;
        border-radius: 999px;
        background: #20283a;
        color: #bcd2ff;
        border: 1px solid #2a3550;
      }

      main {
        display: grid;
        grid-template-columns: 1fr 320px;
        gap: 16px;
      }
      .board {
        background: var(--panel);
        border: 1px solid #212636;
        border-radius: var(--radius);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      /* diamond grid */
      .grid {
        display: grid;
        grid-template-columns: repeat(3, var(--cell-size));
        grid-template-rows: repeat(3, var(--cell-size));
        gap: var(--grid-gap);
        transform: rotate(45deg); /* ì „ì²´ë¥¼ ë‹¤ì´ì•„ë¡œ */
        user-select: none;
      }
      .cell {
        position: relative;
        width: var(--cell-size);
        height: var(--cell-size);
        background: linear-gradient(180deg, #1a2130, #121722);
        border: 1px dashed #2a3550;
        border-radius: 12px;
        transition: transform 0.15s ease, border-color 0.15s ease,
          box-shadow 0.15s ease;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      }
      .cell.empty {
        opacity: 0.6;
      }
      .cell.over {
        border-color: #5aa8ff;
        box-shadow: 0 0 0 2px rgba(90, 168, 255, 0.15);
      }
      .cell .inner {
        position: absolute;
        inset: 8px;
        transform: rotate(-45deg); /* ë‚´ìš©ì€ ìˆ˜í‰ìœ¼ë¡œ ë³´ì´ê²Œ */
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .shop {
        width: 100%;
        height: 100%;
        background: var(--card);
        border: 1px solid #263149;
        border-radius: 10px;
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
      }
      .shop.dragging {
        opacity: 0.5;
      }
      .shop.locked {
        outline: 2px dashed #39415b;
      }
      .title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
      }
      .name {
        font-weight: 700;
        letter-spacing: 0.2px;
        color: #cde3ff;
      }
      .lv {
        font-size: 0.85rem;
        color: #e9e9ff;
        background: #2a3550;
        border: 1px solid #36446a;
        padding: 2px 8px;
        border-radius: 999px;
      }
      .main-badge {
        font-size: 0.7rem;
        color: #0a1222;
        background: linear-gradient(180deg, #b0f1ff, #7bd2ff);
        border: 1px solid #5ab7ff;
        padding: 2px 6px;
        border-radius: 6px;
        font-weight: 700;
      }

      .gauge {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
        justify-content: center;
      }
      .bar-wrap {
        height: 10px;
        background: #131827;
        border-radius: 999px;
        border: 1px solid #2a3550;
        overflow: hidden;
      }
      .bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #67e8f9, #a78bfa);
        transition: width 0.18s ease;
      }
      .stat {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #aab4c7;
      }

      .actions {
        display: flex;
        gap: 6px;
      }
      .btn {
        appearance: none;
        border: 1px solid #2a3550;
        background: #1c2436;
        color: #cfe2ff;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 700;
        cursor: pointer;
      }
      .btn:hover {
        filter: brightness(1.1);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .btn-collect {
        background: linear-gradient(180deg, #2b394f, #1a2436);
        border-color: #34507a;
        color: #e9f6ff;
      }
      .btn-collect.ready {
        background: linear-gradient(180deg, #34d399, #10b981);
        border-color: #128c6b;
        color: #062015;
      }
      .btn-sell {
        background: linear-gradient(180deg, #40222a, #2a1820);
        border-color: #653545;
        color: #ffdce3;
      }
      .btn-move {
        background: #273146;
        border-color: #34405a;
      }

      .panel {
        background: var(--panel);
        border: 1px solid #212636;
        border-radius: var(--radius);
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: var(--shadow);
      }
      .info {
        background: #101625;
        border: 1px solid #223055;
        padding: 10px;
        border-radius: 8px;
        color: #c6d7ff;
        font-size: 0.92rem;
      }
      .info b {
        color: #86b7ff;
      }
      .stack {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .big {
        padding: 12px 14px;
        border-radius: 10px;
        font-size: 1.05rem;
        letter-spacing: 0.2px;
      }
      .accent {
        background: linear-gradient(180deg, #1a2a4a, #152137);
        border-color: #39507a;
      }
      .accent-2 {
        background: linear-gradient(180deg, #21345a, #17243f);
        border-color: #405a92;
      }
      .help {
        color: #9fb0c9;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      .help li {
        margin: 0.25em 0;
      }

      .toast {
        position: fixed;
        left: 50%;
        top: 18px;
        transform: translateX(-50%);
        background: #111827;
        color: #e5e7eb;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #2a3550;
        box-shadow: var(--shadow);
        z-index: 1000;
        opacity: 0;
        animation: pop 0.2s ease forwards, fade 2.6s ease forwards;
      }
      @keyframes pop {
        to {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      @keyframes fade {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }

      .gain {
        position: absolute;
        right: 8px;
        bottom: 8px;
        font-weight: 800;
        font-size: 0.9rem;
        color: #ffe08a;
        text-shadow: 0 2px 8px rgba(255, 221, 120, 0.35);
        opacity: 0;
        transform: translateY(6px);
        animation: rise 0.9s ease forwards;
      }
      @keyframes rise {
        to {
          opacity: 1;
          transform: translateY(-6px);
        }
      }

      @media (max-width: 840px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="gold">
          ë³´ìœ  ê³¨ë“œ: <span class="val" id="gold">0</span> ğŸª™
        </div>
        <div class="meta">
          <span class="tag">ìµœëŒ€ ë ˆë²¨ 30</span>
          <span class="tag">ê°™ì€ ë ˆë²¨ë§Œ ë¨¸ì§€</span>
          <span class="tag">ì„¼í„°=ë©”ì¸(ì´ë™ ë¶ˆê°€)</span>
        </div>
      </header>

      <main>
        <section class="board">
          <div class="grid" id="grid"></div>
        </section>

        <section class="panel">
          <div class="info" id="installInfo">
            ì§€ê¸ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>Lv.1</b> ê³¼ <b>Lv.1</b> ë§¤ì¥ì´ ì„¤ì¹˜ë©ë‹ˆë‹¤.
          </div>
          <div class="stack">
            <button class="btn big accent" id="btnAdd">â• ë§¤ì¥ ì¶”ê°€ì„¤ì¹˜</button>
            <button class="btn big accent-2" id="btnWork">
              ğŸ’¼ ì¥ì‚¬í•˜ê¸° (í…ŒìŠ¤íŠ¸)
            </button>
          </div>
          <div class="help">
            <ul>
              <li>
                ìƒì ì„ <b>ë“œë˜ê·¸</b>í•´ì„œ ê°™ì€ ë ˆë²¨ ìƒì  ìœ„ì— ë†“ìœ¼ë©´
                <b>+1 ë ˆë²¨</b>ë¡œ ì§„í™”í•´ìš”.
              </li>
              <li>
                ê²Œì´ì§€ê°€ ê½‰ ì°¨ë©´ <b>ìˆ˜ë ¹í•˜ê¸°</b> ë²„íŠ¼ìœ¼ë¡œ ê³¨ë“œë¥¼ ì–»ìŠµë‹ˆë‹¤.
              </li>
              <li>
                ë©”ì¸(ê°€ìš´ë°)ì€ <b>ì´ë™ ë¶ˆê°€</b>ì§€ë§Œ, ë‹¤ë¥¸ ìƒì ì„ ëŒì–´ì™€
                <b>ë¨¸ì§€ ëŒ€ìƒ</b>ì´ ë  ìˆ˜ ìˆì–´ìš”.
              </li>
              <li>ë¹ˆì¹¸ì´ ëª¨ìë¼ë©´ ì„¤ì¹˜ëŠ” ê°€ëŠ¥í•œ ë²”ìœ„ê¹Œì§€ë§Œ ì§„í–‰ë©ë‹ˆë‹¤.</li>
              <li>
                ë§¤ê°ì€ ì†Œì•¡ ê³¨ë“œë§Œ ì§€ê¸‰ë˜ì–´ <b>ì•…ìš©ì´ ì–´ë µê²Œ</b> ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.
              </li>
            </ul>
          </div>
        </section>
      </main>
    </div>

    <script>
      // ---------- ê²Œì„ ì„¤ì •(ë°¸ëŸ°ìŠ¤) ----------
      const MAX_LEVEL = 30;
      const FILL_PER_CLICK = 25; // ì¥ì‚¬í•˜ê¸°(í…ŒìŠ¤íŠ¸)ë¡œ ì±„ì›Œì§€ëŠ” ê³ ì •ëŸ‰

      // ê²Œì´ì§€ ìš©ëŸ‰: ë ˆë²¨ì´ ì˜¤ë¥¼ìˆ˜ë¡ ê½¤ ê°€íŒŒë¥´ê²Œ ì¦ê°€(ì„ í˜• + ì•½í•œ 2ì°¨ ì„±ì¥)
      function capacityFor(level) {
        const L = Math.max(1, Math.min(MAX_LEVEL, level));
        // L=1:100, L=10:~775, L=20:~2380, L=30:~5035
        return Math.round(100 + 35 * (L - 1) + 5 * (L - 1) * (L - 2));
      }
      // ìˆ˜ë ¹ ë³´ìƒ: ê³¼í•˜ì§€ ì•Šê²Œ ë‹¤í•­ ì„±ì¥(í›„ë°˜ ë‚œì´ë„ â†‘)
      function rewardFor(level) {
        const L = Math.max(1, Math.min(MAX_LEVEL, level));
        // 50 * L^1.6  (L1:50, L10:~1990, L20:~6015, L30:~11550)
        return Math.round(50 * Math.pow(L, 1.6));
      }
      // ë§¤ê° ê¸ˆì•¡: ì•…ìš© ë°©ì§€ë¥¼ ìœ„í•´ ë§¤ìš° ë‚®ê²Œ(ë ˆë²¨+ì§„í–‰ë„ ì†Œí­ ë°˜ì˜)
      function sellValueFor(level, progressRatio) {
        const base = 5 * level; // L30ë„ 150 ì •ë„
        const prog = 10 * Math.max(0, Math.min(1, progressRatio));
        return Math.max(1, Math.round(base + prog));
      }

      // ---------- ìœ í‹¸ ----------
      const fmt = (n) => n.toLocaleString("ko-KR");
      const el = (sel, root = document) => root.querySelector(sel);
      const elAll = (sel, root = document) => [...root.querySelectorAll(sel)];
      function toast(msg) {
        const t = document.createElement("div");
        t.className = "toast";
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 2600);
      }

      // ---------- ìƒíƒœ ----------
      let gold = 0;
      const centerIndex = 4; // 3x3 ê°€ìš´ë°
      let uid = 1;

      // ë³´ë“œ: ì¸ë±ìŠ¤ 0..8
      /** @type {(null|{id:number, level:number, current:number, isMain:boolean})[]} */
      let board = Array(9).fill(null);

      function makeShop(level, isMain = false) {
        return {
          id: uid++,
          level: Math.max(1, Math.min(MAX_LEVEL, level)),
          current: 0,
          isMain,
        };
      }

      function init() {
        board[centerIndex] = makeShop(1, true); // ë©”ì¸ Lv.1 ì‹œì‘
        render();
      }

      // ---------- ë Œë” ----------
      function render() {
        // ì„¤ì¹˜ ì•ˆë‚´ë¬¸êµ¬ ê°±ì‹ 
        const main = board[centerIndex];
        const addL1 = 1;
        const addL2 = Math.max(1, (main?.level || 1) - 3);
        const free = board.filter(
          (x, i) => i !== centerIndex && x === null
        ).length;
        el("#installInfo").innerHTML =
          `ì§€ê¸ˆ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <b>Lv.${addL1}</b> ê³¼ <b>Lv.${addL2}</b> ë§¤ì¥ì´ ì„¤ì¹˜ë©ë‹ˆë‹¤. ` +
          `(ë¹ˆì¹¸: <b>${free}</b>)`;

        // ê³¨ë“œ
        el("#gold").textContent = fmt(gold);

        // ê·¸ë¦¬ë“œ
        const grid = el("#grid");
        grid.innerHTML = "";

        for (let i = 0; i < 9; i++) {
          const cell = document.createElement("div");
          cell.className = "cell" + (board[i] ? "" : " empty");
          cell.dataset.index = i;
          const inner = document.createElement("div");
          inner.className = "inner";

          if (board[i]) {
            const shop = board[i];
            const cap = capacityFor(shop.level);
            const pct = Math.min(100, Math.round((shop.current / cap) * 100));

            const card = document.createElement("div");
            card.className = "shop" + (shop.isMain ? " locked" : "");
            card.draggable = !shop.isMain;
            card.dataset.index = i;
            card.dataset.id = shop.id;

            // ë“œë˜ê·¸ ì´ë²¤íŠ¸
            card.addEventListener("dragstart", onDragStart);
            card.addEventListener("dragend", onDragEnd);

            // ìƒë‹¨
            const title = document.createElement("div");
            title.className = "title";
            title.innerHTML = `<span class="name">${
              shop.isMain ? "ë©”ì¸ ë§¤ì¥" : "ìƒì "
            }</span>
			                          <span class="lv">Lv.${shop.level}</span>`;
            if (shop.isMain) {
              const b = document.createElement("span");
              b.className = "main-badge";
              b.textContent = "MAIN";
              title.appendChild(b);
            }
            card.appendChild(title);

            // ê²Œì´ì§€ / ìˆ˜ë ¹
            const actions = document.createElement("div");
            actions.className = "actions";

            const gauge = document.createElement("div");
            gauge.className = "gauge";
            const stat = document.createElement("div");
            stat.className = "stat";
            stat.innerHTML = `<span>íŒë§¤ëŸ‰ ê²Œì´ì§€</span><span>${fmt(
              shop.current
            )} / ${fmt(cap)} (${pct}%)</span>`;
            const wrap = document.createElement("div");
            wrap.className = "bar-wrap";
            const bar = document.createElement("div");
            bar.className = "bar";
            bar.style.width = pct + "%";
            wrap.appendChild(bar);
            gauge.appendChild(stat);
            gauge.appendChild(wrap);

            const collectBtn = document.createElement("button");
            collectBtn.className =
              "btn btn-collect" + (shop.current >= cap ? " ready" : "");
            collectBtn.textContent =
              shop.current >= cap
                ? `ìˆ˜ë ¹í•˜ê¸° +${fmt(rewardFor(shop.level))}`
                : `ë³´ìƒ: ${fmt(rewardFor(shop.level))}`;
            collectBtn.disabled = !(shop.current >= cap);
            collectBtn.addEventListener("click", () => {
              if (shop.current < cap) return;
              const gain = rewardFor(shop.level);
              gold += gain;
              shop.current = 0;
              render();
              // ì´í™íŠ¸
              const fx = document.createElement("div");
              fx.className = "gain";
              fx.textContent = `+${fmt(gain)} ğŸª™`;
              card.appendChild(fx);
              setTimeout(() => fx.remove(), 1000);
            });

            actions.appendChild(collectBtn);

            if (!shop.isMain) {
              const sellBtn = document.createElement("button");
              sellBtn.className = "btn btn-sell";
              const val = sellValueFor(shop.level, shop.current / cap);
              sellBtn.textContent = `ë§¤ê° ${fmt(val)}ğŸª™`;
              sellBtn.addEventListener("click", () => {
                gold += val;
                board[i] = null;
                render();
                toast(`ë§¤ê° +${fmt(val)} ê³¨ë“œ`);
              });
              actions.appendChild(sellBtn);
            }

            card.appendChild(gauge);
            card.appendChild(actions);
            inner.appendChild(card);
          }

          cell.appendChild(inner);

          // ë“œë íƒ€ê²Ÿ ì´ë²¤íŠ¸(ì…€)
          cell.addEventListener("dragover", onDragOver);
          cell.addEventListener("dragleave", onDragLeave);
          cell.addEventListener("drop", onDrop);

          grid.appendChild(cell);
        }
      }

      // ---------- ë“œë˜ê·¸/ë“œë¡­ ----------
      let dragSrcIndex = null;

      function onDragStart(e) {
        const idx = Number(e.currentTarget.dataset.index);
        dragSrcIndex = idx;
        e.dataTransfer.setData("text/plain", String(idx));
        e.currentTarget.classList.add("dragging");
      }
      function onDragEnd(e) {
        e.currentTarget.classList.remove("dragging");
        dragSrcIndex = null;
        elAll(".cell.over").forEach((c) => c.classList.remove("over"));
      }
      function onDragOver(e) {
        e.preventDefault(); // drop í—ˆìš©
        e.currentTarget.classList.add("over");
      }
      function onDragLeave(e) {
        e.currentTarget.classList.remove("over");
      }
      function onDrop(e) {
        e.preventDefault();
        const dstIdx = Number(e.currentTarget.dataset.index);
        elAll(".cell.over").forEach((c) => c.classList.remove("over"));

        const srcIdx =
          dragSrcIndex ?? Number(e.dataTransfer.getData("text/plain"));
        if (Number.isNaN(srcIdx)) return;
        if (srcIdx === dstIdx) return;

        const src = board[srcIdx];
        const dst = board[dstIdx];
        if (!src) return;

        // ë©”ì¸ ì´ë™ ë°©ì§€
        if (src.isMain) {
          toast("ë©”ì¸ ë§¤ì¥ì€ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        if (!dst) {
          // ë¹ˆì¹¸ìœ¼ë¡œ ì´ë™
          board[dstIdx] = src;
          board[srcIdx] = null;
          render();
          return;
        }

        // ê°™ì€ ë ˆë²¨ì´ë©´ ë¨¸ì§€
        if (dst && src.level === dst.level) {
          if (dst.level >= MAX_LEVEL) {
            toast(`ì´ë¯¸ ìµœëŒ€ ë ˆë²¨(${MAX_LEVEL})ì…ë‹ˆë‹¤.`);
            return;
          }
          const newLevel = Math.min(MAX_LEVEL, dst.level + 1);
          const kept = Math.max(src.current, dst.current); // ë” ë†’ì€ ê²Œì´ì§€ ìœ ì§€
          const newCap = capacityFor(newLevel);
          const newCurrent = Math.min(newCap, kept); // ìš©ëŸ‰ ì´ˆê³¼ ë°©ì§€

          // dstì— í•©ì¹˜ê³  src ë¹„ìš°ê¸°
          board[dstIdx] = {
            id: dst.id,
            level: newLevel,
            current: newCurrent,
            isMain: dst.isMain,
          };
          board[srcIdx] = null;
          render();
          toast(`ë¨¸ì§€ ì„±ê³µ! Lv.${newLevel} âœ¨`);
          return;
        }

        // ê·¸ ì™¸ì—ëŠ” ë¶ˆê°€
        toast("ê°™ì€ ë ˆë²¨ë¼ë¦¬ë§Œ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      }

      // ---------- ì•¡ì…˜ ----------
      el("#btnWork").addEventListener("click", () => {
        let changed = false;
        for (let i = 0; i < 9; i++) {
          const s = board[i];
          if (!s) continue;
          const cap = capacityFor(s.level);
          const before = s.current;
          s.current = Math.min(cap, s.current + FILL_PER_CLICK);
          if (s.current !== before) changed = true;
        }
        if (changed) render();
      });

      el("#btnAdd").addEventListener("click", () => {
        const main = board[centerIndex];
        const level = Math.max(1, (main?.level || 1) - 3);

        // ë¹ˆ ì¹¸ ìˆ˜ì§‘(ì„¼í„° ì œì™¸)
        const empties = [];
        for (let i = 0; i < 9; i++) {
          if (i === centerIndex) continue;
          if (!board[i]) empties.push(i);
        }

        if (empties.length === 0) {
          toast("ì„¤ì¹˜í•  ë¹ˆ ì¹¸ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // ë¬´ì‘ìœ„ ìœ„ì¹˜ì— ìµœëŒ€ 2ê°œ ì„¤ì¹˜
        shuffle(empties);
        const idx = empties[0];
        const s = makeShop(level, false);
        board[idx] = s;

        render();
        toast(`ë§¤ì¥ ${toPlace}ê°œ ì„¤ì¹˜ ì™„ë£Œ`);
      });

      function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      // ---------- ì‹œì‘ ----------
      init();
    </script>
  </body>
</html>
